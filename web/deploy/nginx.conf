server {
  listen 80;
  server_name onchat.sebayaki.com;

  access_log /srv/onchat/logs/nginx-access.log;
  error_log /srv/onchat/logs/nginx-error.log;

  # Serve ACME challenge files
  location ^~ /.well-known/acme-challenge/ {
    allow all;
    root /srv/onchat/current;
    try_files $uri $uri/ =404;
  }

  # Redirect HTTP to HTTPS
  location / {
    return 301 https://$host$request_uri;
  }
}

server {
  listen 443 ssl http2;
  server_name onchat.sebayaki.com;

  access_log /srv/onchat/logs/nginx-access.log;
  error_log /srv/onchat/logs/nginx-error.log;

  ssl_certificate /etc/letsencrypt/live/onchat.sebayaki.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/onchat.sebayaki.com/privkey.pem;

  # Gzip compression
  gzip on;
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 5;
  gzip_min_length 256;
  gzip_types
    text/plain
    text/css
    text/javascript
    application/javascript
    application/json
    application/xml
    image/svg+xml;

  root /srv/onchat/current;
  index index.html;

  location / {
    sub_filter '__REQUEST_PATH__' '$request_uri';
    sub_filter_once off;
    try_files $uri $uri.html $uri/ /index.html;
  }

  # Cache static assets (Vite outputs to /assets/)
  location /assets/ {
    expires 365d;
    access_log off;
    add_header Cache-Control "public, immutable";
  }

  # Error pages
  error_page 404 /404.html;
  location = /404.html {
    internal;
  }
}
